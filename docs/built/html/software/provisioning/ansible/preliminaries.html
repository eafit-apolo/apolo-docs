

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Inventory &mdash; apolo-docs 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/sidebar.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="1. Tags" href="dynamic_control.html" />
    <link rel="prev" title="Ansible" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

  
    <a href="../../../index.html">
  

  
    
    <img src="../../../_static/apolo-white.png" style="width: 150px;" class="logo" alt="Logo"/>
  
    </a>

    
      
      
      
	<div class="version" style="color: rgba(255,255,255,0.5);">
	  0.1
	</div>
      
    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../supercomputers/index.html">Supercomputers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/index.html">Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../programminglanguages/index.html">Programming Languages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../applications/index.html">Scientific Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../resourcemanager/index.html">Resource Manager</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Provisioning</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Ansible</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="index.html#basic-information">Basic information</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#preliminaries">Preliminaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#dynamic-control">Dynamic control</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#deployment-strategy">Deployment strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#tips-and-tricks">Tips and tricks</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#authors">Authors</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../monitoring/index.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operatingsystems/index.html">Operating Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scientific_libraries/index.html">Scientific Libraries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to-acknowledge.html">How to Acknowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../report-a-bug.html">Report a Bug</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">apolo-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Software</a> &raquo;</li>
        
          <li><a href="../index.html">Provisioning</a> &raquo;</li>
        
          <li><a href="index.html">Ansible</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>Inventory</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/software/provisioning/ansible/preliminaries.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="inventory">
<span id="sssec-ansible-inventory"></span><h1><span class="section-number">1. </span>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h1>
<p>Ansible performs actions, also known as tasks, over a group of computers; in order to
do so it reads a plain text file called “inventory file” containing a list of
hostnames, or IP addresses, often grouped based on one or multiple shared features.</p>
<p>The inventory file is located by default under <code class="code bash docutils literal notranslate"><span class="pre">/etc/ansible/hosts</span></code>
and would typically follow the conventions shown below:</p>
<ol class="arabic">
<li><p>Group names are delimited by <code class="code bash docutils literal notranslate"><span class="operator"><span class="pre">[</span></span></code> and <code class="code bash docutils literal notranslate"><span class="operator"><span class="pre">]</span></span></code>. e.g. group lbservers would be written as <code class="code bash docutils literal notranslate"><span class="operator"><span class="pre">[</span></span><span class="pre">lbservers</span><span class="operator"><span class="pre">]</span></span></code>.</p></li>
<li><p>Hosts below a group definition are to be taken as members of it. e.g.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; lbservers -&gt; Group</span>
<span class="c1">; [host1,host2].example.com -&gt; Members</span>
<span class="k">[lbservers]</span>
<span class="na">host1.example.com</span>
<span class="na">host2.example.com</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="lbservers' components" src="../../../_images/inventory_example-1.png" />
</div>
</li>
<li><p>Using the suffix <code class="code bash docutils literal notranslate"><span class="pre">:children</span></code> within a group definition indicates the presence of
nested groups (i.e. subgroups). e.g.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; lbservers -&gt; Group</span>
<span class="c1">; lb[south,north] -&gt; Subgroups</span>
<span class="k">[lbservers:children]</span>
<span class="na">lbsouth</span>
<span class="na">lbnorth</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Subgroups are only declared as part of a parent-child relation
(i.e. nesting depth is 1), thus implying that relations where
nesting depth is greater than 1 require multiple declarations.</p>
</div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; lbservers -&gt; Grandparent</span>
<span class="c1">; lb[south,north] -&gt; Children</span>
<span class="k">[lbservers:children]</span>
<span class="na">lbsouth</span>
<span class="na">lbnorth</span>

<span class="c1">; lbs[1,2].example.com -&gt; Grandchildren</span>
<span class="k">[lbsouth]</span>
<span class="na">lbs1.example.com</span>
<span class="na">lbs2.example.com</span>
</pre></div>
</div>
</li>
<li><p>The suffix <code class="code bash docutils literal notranslate"><span class="pre">:vars</span></code> within a group definition is used to declare and assign
variables to a particular set of hosts or subgroups. e.g.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These variables are relative to group members and can be overwritten
by subgroups and other ansible components (e.g. playbooks, tasks).
See <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">Ansible’s Variable Precedence article</a> for more information.</p>
</div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; lbsouth and lbnorth will inherit all</span>
<span class="c1">; variables declared within lbservers.</span>
<span class="k">[lbservers:children]</span>
<span class="na">lbsouth</span>
<span class="na">lbnorth</span>

<span class="k">[lbservers:vars]</span>
<span class="na">requests_timeout</span><span class="o">=</span><span class="s">5</span>
<span class="na">max_hosts_to_serve</span><span class="o">=</span><span class="s">10</span>

<span class="c1">; &quot;requests_timeout&quot; will be overwritten</span>
<span class="c1">; for lbsouth members only.</span>
<span class="k">[lbsouth:vars]</span>
<span class="na">requests_timeout</span><span class="o">=</span><span class="s">3</span>

<span class="c1">; Members of this group will not recognize</span>
<span class="c1">; variables declared for lbservers, as they</span>
<span class="c1">; do not belong to it.</span>
<span class="k">[backupservers]</span>
<span class="na">bk1.example.com</span>
<span class="na">bk2.example.com</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="lbservers' components" src="../../../_images/inventory_example-children.png" />
</div>
</li>
</ol>
<p>It is impotant to highlight that there are two default groups: <code class="code bash docutils literal notranslate"><span class="pre">all</span></code> and
<code class="code bash docutils literal notranslate"><span class="pre">ungrouped</span></code>, which, unlike any other group, can be omitted within the
inventory file, as their definitions are both implicit. Please be aware that:</p>
<ol class="arabic simple">
<li><p>Hierarchically, all groups and hosts are members of <code class="code bash docutils literal notranslate"><span class="pre">all</span></code>.</p></li>
<li><p>Hosts with no group other than all belong to <code class="code bash docutils literal notranslate"><span class="pre">ungrouped</span></code>. Therefore, hosts
will be members of at least two groups.</p></li>
</ol>
<p>Hence, it is true for the examples above:</p>
<div class="figure align-default">
<img alt="lbservers' components" src="../../../_images/inventory_example-implicit.png" />
</div>
</div>
<div class="section" id="group-variables">
<span id="sssec-ansible-groupvars"></span><h1><span class="section-number">2. </span>Group variables<a class="headerlink" href="#group-variables" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature will not be detailed, as there is plenty of information about it in
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#splitting-out-host-and-group-specific-data">Ansible’s document: Working with Inventory</a></p>
</div>
<p>Keeping too much data within the inventory file can make it become complex, difficult
to read and maintain. Ansible allows to easily bypass this issue by introducing a
mechanism to split groups and hosts data:</p>
<ol class="arabic">
<li><p>Create a folder called <code class="code bash docutils literal notranslate"><span class="pre">group_vars</span></code> at the same level as the inventory file.
That is, if the inventory file is located under <code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span></code> then the
folder must be there as well. e.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p <span class="nv">$ANSIBLE_HOME</span>/group_vars
ls <span class="nv">$ANSIBLE_HOME</span>/
inventory    group_vars/
</pre></div>
</div>
</li>
<li><p>Create files under <code class="code bash docutils literal notranslate"><span class="pre">group_vars</span></code> matching your group names and store the
corresponding variables into each one. Take the example from the <a class="reference internal" href="#inventory">Inventory</a>
section; There are variables declared for two groups, hence there would be
two files under <code class="code bash docutils literal notranslate"><span class="pre">group_vars</span></code> as shown below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbservers</span>
<span class="nn">---</span>
<span class="nt">requests_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="nt">max_hosts_to_serve</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbsouth</span>
<span class="nn">---</span>
<span class="nt">requests_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
</li>
</ol>
<p>Moreover, variables within a group can be further organized by decoupling the
files inside <code class="code bash docutils literal notranslate"><span class="pre">group_vars</span></code>. Ansible will read all files under
directories named after groups or hosts. For instance, variables from the
lbservers group can reside in multiple files under
<code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/group_vars/lbservers/</span></code>. e.g.</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbservers/requests</span>
<span class="nn">---</span>
<span class="nt">requests_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbservers/config</span>
<span class="nn">---</span>
<span class="nt">max_hosts_to_serve</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="modules">
<span id="sssec-ansible-modules"></span><h1><span class="section-number">3. </span>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h1>
<p>A module can be interpreted as a function ansible calls from a task. Basically,
a module is the function’s entire body (i.e. declaration), waiting to be
called from a task or an ansible ad-hoc command.</p>
</div>
<div class="section" id="playbooks">
<span id="sssec-ansible-playbooks"></span><h1><span class="section-number">4. </span>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h1>
<p>A playbook is a text file, written in YAMl format, containing information on
which tasks to apply on which hosts. This information is contained within a
definition block called “Play”. Take the following playbook for example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lbsouth</span>
  <span class="nt">vars</span><span class="p">:</span>
    <span class="nt">nginx_conf_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/nginx/</span>

<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lbnorth</span>
  <span class="nt">vars</span><span class="p">:</span>
    <span class="nt">nginx_conf_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/nginx/</span>

<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lbservers</span>
  <span class="nt">vars</span><span class="p">:</span>
    <span class="nt">nginx_log_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/log/ansible</span>
  <span class="nt">tasks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install/update nginx</span>
    <span class="nt">yum</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
      <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Place nginx config file</span>
    <span class="nt">template</span><span class="p">:</span>
      <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">templates/nginx.conf.j2</span>
      <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nginx_conf_dir</span><span class="nv"> </span><span class="s">}}/nginx.conf&quot;</span>
    <span class="nt">notify</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure nginx is running</span>
    <span class="nt">systemd</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
      <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
      <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">handlers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>
      <span class="nt">systemd</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
</pre></div>
</div>
<p>Plays are separated by a non-printable ‘\n’, thus there are three plays. Each one
uses the keyword “hosts” to describe a group, defined in the inventory file,
on which to apply some tasks and/or set variables, keywords “tasks” and “vars”
respectively.</p>
<p>An easy way to comprehend what a playbook is, and why it is useful, is thinking on
what would one need to do in scripting languages, like bash, to accomplish what
a playbook is meant to. Take the task “Place nginx config file”. It calls
Ansible’s <code class="code bash docutils literal notranslate"><span class="pre">template</span></code> module, which creates a file based
on a Jinja2 template. Hence, one could either use templates alongside bash, which
becomes complex and difficult to maintain really fast, use an external software to
parse them, like ruby <code class="code bash docutils literal notranslate"><span class="pre">erb</span></code> or python + Jinja2, or manage static
files. Thereupon, additional concerns arise: how to deliver
files to lbservers’ hosts?, how to manage variables within them?, etc. Basically,
these questions represent steps to achieve something specific (for the task under
consideration, place a file called <code class="code bash docutils literal notranslate"><span class="pre">nginx.conf</span></code>, whose content may vary,
on all hosts within lbservers) that can be interpreted as to lead a system to a
desired state. e.g.</p>
<ul class="simple">
<li><p>Original state: lbservers’ hosts not having <code class="code bash docutils literal notranslate"><span class="pre">nginx.conf</span></code></p></li>
<li><p>Desired state: lbservers’ hosts having <code class="code bash docutils literal notranslate"><span class="pre">nginx.conf</span></code></p></li>
</ul>
<p>A playbook can be, therefore, defined as the abstraction of a system’s final state,
comprised of intermediate states represented by tasks.
Sort of an assembly line analogy:</p>
<div class="figure align-default" id="id6">
<img alt="McDonald's assembly line" src="../../../_images/McDonalds-Assembly-Line.jpg" />
<p class="caption"><span class="caption-text">McDonald’s assembly line. Retrieved august 28, 2018 from <a class="reference external" href="https://slideplayer.com/slide/9882222/">https://slideplayer.com/slide/9882222/</a></span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<p>Task 1 would represent an ansible run being triggered, tasks 2 to 5 the system’s pass
through each intermediate state
(i.e. bun toasted, bun assembled with condiments, patty wrapped,
Order placed on heated landing pad) and task 6 the desired state (i.e. customer satisfied).</p>
</div>
<div class="section" id="roles">
<span id="sssec-ansible-roles"></span><h1><span class="section-number">5. </span>Roles<a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h1>
<p>A role is a hierarchical directory structure intended to decouple playbooks
by breaking them into multiple files, which is particularly useful to
create reusable components and write simpler playbooks.
A role’s layout would typically look as below:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are more directories than those listed below. See <a class="reference external" href="https://docs.ansible.com/ansible/2.5/user_guide/playbooks_reuse_roles.html">Ansible’s official documentation</a>
for more information.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;playbook <span class="m">1</span>&gt;
&lt;playbook <span class="m">2</span>&gt;
.
.
.
&lt;playbook n&gt;
inventory
roles/
  common/
    tasks/
    handlers/
    files/
    templates/
    vars/
</pre></div>
</div>
<p>Let us elucidate on how playbooks can be decoupled by using the notion of a role. Take the
example on the <a class="reference internal" href="#playbooks">Playbooks</a> section.</p>
<ol class="arabic">
<li><p><strong>Identify a common feature within your tasks</strong>. For example, all tasks on the
third play are related to nginx.</p></li>
<li><p>Use that common feature as a base to name your role and create a directory
under <code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span></code> is used as a way to represent ansible’s folder
location within the filesystem (e.g. /etc/ansible), which
may vary depending on the setup.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p  <span class="nv">$ANSIBLE_HOME</span>/roles/nginx
</pre></div>
</div>
</li>
<li><p><strong>Decouple tasks by placing them in taskfiles</strong>. As the name implies, a taskfile is
a file containing task declarations; this files are often stored under
<code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/&lt;role&gt;/tasks</span></code> and their name is irrelevant exept
for <code class="code bash docutils literal notranslate"><span class="pre">main.yml</span></code>, which must always be present. Although tasks can be all defined
inside <code class="code bash docutils literal notranslate"><span class="pre">main.yml</span></code>, it is recommended to declare them in different taskfiles
when their number is large enough to make a coupled taskfile difficult to read, and then
call each one from <code class="code bash docutils literal notranslate"><span class="pre">main.yml</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/tasks/packages.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install/update nginx</span>
  <span class="nt">yum</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/tasks/config.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Place nginx config file</span>
<span class=" -Error"> </span><span class="nt">template</span><span class="p">:</span>
   <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">templates/nginx.conf.j2</span>
   <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nginx_conf_dir</span><span class="nv"> </span><span class="s">}}/nginx.conf&quot;</span>
 <span class="nt">notify</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure nginx is running</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/tasks/main.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Including</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">include_tasks</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">with_items</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;packages.yml&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;config.yml&#39;</span>
  <span class="nt">loop_control</span><span class="p">:</span>
    <span class="nt">loop_var</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">taskfile</span>
</pre></div>
</div>
</li>
<li><p><strong>Decouple variables</strong>. Declare them as <a class="reference internal" href="#group-variables">Group variables</a>, in the role’s local
context or within a task. For instance, if one desires the variable
<code class="code bash docutils literal notranslate"><span class="pre">nginx_log_dir</span></code> to be set for all hosts applying the nginx role:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using <code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/&lt;role&gt;/vars</span></code> to store variables visible to all
tasks within a role is a common practice. However, “vars” can be named
differently or even placed under some other location.</p>
<p>One would typically store variables inside
<code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/&lt;role&gt;/vars/main.yml</span></code> as for ansible to auto-load
them, but there is also the alternative to do it manually (shown in this example).</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p <span class="nv">$ANSIBLE_HOME</span>/roles/nginx/vars
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/vars/config.yml</span>
<span class="nn">---</span>
<span class="nt">nginx_log_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/log/ansible</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/tasks/main.yml</span>
<span class="nn">---</span>
<span class="c1"># Unlike group_vars, ansible does not read files</span>
<span class="c1"># inside the vars folder automatically, except &quot;main.yml&quot;.</span>
<span class="c1"># Therefore, in this case, it must explicitly be told to do so.</span>
<span class="c1"># Remark: vars&#39; location may vary.</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;Include</span><span class="nv"> </span><span class="s">variables&#39;</span>
  <span class="nt">include_vars</span><span class="p">:</span>
    <span class="nt">dir</span><span class="p">:</span> <span class="s">&#39;../vars&#39;</span>
    <span class="nt">extensions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">yml</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Including</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">include_tasks</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">taskfile</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">with_items</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;packages.yml&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;config.yml&#39;</span>
  <span class="nt">loop_control</span><span class="p">:</span>
    <span class="nt">loop_var</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">taskfile</span>
</pre></div>
</div>
<p>As for the variables under <code class="code bash docutils literal notranslate"><span class="pre">lbsouth</span></code> and <code class="code bash docutils literal notranslate"><span class="pre">lbnorth</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbnorth</span>
<span class="nn">---</span>
<span class="nt">nginx_conf_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/nginx/conf</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/group_vars/lbsouth</span>
<span class="nn">---</span>
<span class="nt">requests_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="nt">nginx_conf_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/nginx/conf</span>
</pre></div>
</div>
</li>
<li><p><strong>Decouple handlers</strong>. Handlers are stored the same way taskfiles are, but in
a different location. They are placed inside the “handler” directory, which
is at the same level as the “tasks” directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p <span class="nv">$ANSIBLE_HOME</span>/roles/nginx/handlers
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/handlers/main.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
</pre></div>
</div>
</li>
<li><p><strong>Decouple templates</strong>. Stored under <code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/&lt;role&gt;/templates</span></code>,
it is highly recommended to create a directory structure resembling that of the
location where templates will be rendered. e.g. <code class="code bash docutils literal notranslate"><span class="pre">nginx.conf</span></code> will be
rendered in <code class="code bash docutils literal notranslate"><span class="pre">/etc/nginx/conf</span></code> for <code class="code bash docutils literal notranslate"><span class="pre">lbsouth</span></code> and <code class="code bash docutils literal notranslate"><span class="pre">/opt/nginx/conf</span></code>,
for <code class="code bash docutils literal notranslate"><span class="pre">lbnorth</span></code>, hence the template would reside in either
<code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/nginx/templates/etc/nginx/conf</span></code> or
<code class="code bash docutils literal notranslate"><span class="name variable"><span class="pre">$ANSIBLE_HOME</span></span><span class="pre">/roles/nginx/templates/opt/nginx/conf</span></code>. Note modifying the layout
also implies adjusting all tasks using <code class="code bash docutils literal notranslate"><span class="pre">nginx.conf.j2</span></code>.</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># $ANSIBLE_HOME/roles/nginx/tasks/config.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Place nginx config file</span>
<span class=" -Error"> </span><span class="nt">template</span><span class="p">:</span>
<span class="hll">   <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">templates/etc/nginx/conf/nginx.conf.j2</span>
</span>   <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nginx_conf_dir</span><span class="nv"> </span><span class="s">}}/nginx.conf&quot;</span>
 <span class="nt">notify</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure nginx is running</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p><strong>Call the role</strong> from the playbook (Note how it became simpler).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lbservers</span>
  <span class="nt">roles</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
</pre></div>
</div>
</li>
</ol>
<p>Finally, consider the designated behavior for each role ‘x’ component
(Taken from <a class="footnote-reference brackets" href="#five" id="id1">5</a>):</p>
<ul class="simple">
<li><p>If roles/x/tasks/main.yml exists, tasks listed therein will be added to the play.</p></li>
<li><p>If roles/x/handlers/main.yml exists, handlers listed therein will be added to the play.</p></li>
<li><p>If roles/x/vars/main.yml exists, variables listed therein will be added to the play.</p></li>
<li><p>If roles/x/defaults/main.yml exists, variables listed therein will be added to the play.</p></li>
<li><p>If roles/x/meta/main.yml exists, any role dependencies listed therein will be added to the list of roles (ansible 1.3 and later).</p></li>
<li><p>Any copy, script, template or include tasks (in the role) can reference files in roles/x/{files,templates,tasks}/ (dir depends on task) without having to path them relatively or absolutely.</p></li>
</ul>
</div>
<div class="section" id="vault-encryption">
<span id="sssec-ansible-vault"></span><h1><span class="section-number">6. </span>Vault (Encryption)<a class="headerlink" href="#vault-encryption" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some features will not be detailed. Basic usage can be found in
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html?highlight=vault">Ansible’s document: Ansible Vault</a></p>
</div>
<p>“New in Ansible 1.5, “Vault” is a feature of ansible that allows keeping sensitive data such as passwords
or keys in encrypted files, rather than as plaintext in your playbooks or roles. These vault files can
then be distributed or placed in source control.” <a class="footnote-reference brackets" href="#one" id="id2">1</a></p>
<div class="section" id="create-encrypted-files">
<h2><span class="section-number">6.1. </span>Create encrypted files<a class="headerlink" href="#create-encrypted-files" title="Permalink to this headline">¶</a></h2>
<p>The command below will create a temporary file and subsequentially
open it for you to write. Once the file is saved, and the text editor closed,
<em>ansible-vault</em> will automatically generate an encrypted version of it and erase
the original.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault --vault-id &lt;env&gt;@&lt;vault-password script&gt; create &lt;file&gt;
</pre></div>
</div>
</div></blockquote>
<p>Alternatively, if you intend to be prompted for the password, then:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># You could also use:</span>
<span class="c1"># ansible-vault create &lt;file&gt;</span>
<span class="c1"># However, environments would not be taked into consideration.</span>
ansible-vault --vault-id &lt;env&gt;@prompt create &lt;file&gt;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="encrypt-files">
<h2><span class="section-number">6.2. </span>Encrypt files<a class="headerlink" href="#encrypt-files" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault --vault-id &lt;env&gt;@&lt;vault-password script&gt; encrypt &lt;file-1&gt; <span class="o">[</span>file-2 file-3 ... file-n<span class="o">]</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="encrypt-variables-as-a-string">
<h2><span class="section-number">6.3. </span>Encrypt variables as a string<a class="headerlink" href="#encrypt-variables-as-a-string" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault encrypt_string --vault-id &lt;env&gt;@&lt;vault-password script&gt; --stdin-name <span class="s1">&#39;&lt;varname&gt;&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="edit-encrypted-files">
<h2><span class="section-number">6.4. </span>Edit encrypted files<a class="headerlink" href="#edit-encrypted-files" title="Permalink to this headline">¶</a></h2>
<p>Encrypted files can be edited without being decrypted a priori. See the command below:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault --vault-id &lt;env&gt;@&lt;vault-password script&gt; edit &lt;file&gt;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="view-encrypted-file">
<h2><span class="section-number">6.5. </span>View encrypted file<a class="headerlink" href="#view-encrypted-file" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault --vault-id &lt;env&gt;@&lt;vault-password script&gt; view &lt;file&gt;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="view-encrypted-string">
<h2><span class="section-number">6.6. </span>View encrypted string<a class="headerlink" href="#view-encrypted-string" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible localhost -m debug -a <span class="nv">var</span><span class="o">=</span><span class="s1">&#39;&lt;variable_to_decrypt&gt;&#39;</span> <span class="se">\</span>
-e <span class="s2">&quot;@&lt;file_containing_variable&gt;&quot;</span> <span class="se">\</span>
--vault-id &lt;env&gt;@&lt;vault-password script&gt;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="decrypt-files">
<h2><span class="section-number">6.7. </span>Decrypt files<a class="headerlink" href="#decrypt-files" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault --vault-id &lt;env&gt;@&lt;vault-password script&gt; decrypt &lt;file-1&gt; <span class="o">[</span>file-2 file-3 ... file-n<span class="o">]</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="change-encryption-key">
<h2><span class="section-number">6.8. </span>Change encryption key<a class="headerlink" href="#change-encryption-key" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-vault rekey &lt;file-1&gt; <span class="o">[</span>file-2 file-3 ... file-n<span class="o">]</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="vault-password-script">
<h2><span class="section-number">6.9. </span>vault-password script<a class="headerlink" href="#vault-password-script" title="Permalink to this headline">¶</a></h2>
<p>Vault’s password can be retrieved from a script, as described in <a class="footnote-reference brackets" href="#two" id="id3">2</a>, passed to the
option <code class="code bash docutils literal notranslate"><span class="pre">--vault-id</span></code>, or <code class="code bash docutils literal notranslate"><span class="pre">--vault-password-file</span></code>
from the <code class="code bash docutils literal notranslate"><span class="pre">ansible-vault</span></code> and <code class="code bash docutils literal notranslate"><span class="pre">ansible-playbook</span></code> executables.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The script can be written in python, bash or any other scripting language.</p>
</div>
<p>Scripts invoked by <code class="code bash docutils literal notranslate"><span class="pre">--vault-password-file</span></code> take no arguments,
return the password on stdout and do not have any knowledge about <code class="code bash docutils literal notranslate"><span class="pre">--vault-id</span></code>
or multiple password files whatsoever. Using <code class="code bash docutils literal notranslate"><span class="pre">--vault-id</span></code> to call upon
scripts, on the other hand, enables a ‘protocol’ under which a vault id can be
looked up and its associated password returned thereafter.</p>
<p>Furthermore, <code class="code bash docutils literal notranslate"><span class="pre">--vault-id</span></code> allows for a vault id to be passed a
as an argument thus giving developers the ability to
program more sophisticated vault-password scripts.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>A vault id will only be passed to the script if the latter is named after the
convention <code class="code bash docutils literal notranslate"><span class="pre">&lt;some</span> <span class="pre">name&gt;-client.&lt;extension&gt;</span></code> (e.g. <code class="code bash docutils literal notranslate"><span class="pre">keyring-client.sh</span></code>).
See <a class="footnote-reference brackets" href="#three" id="id4">3</a> and <a class="footnote-reference brackets" href="#four" id="id5">4</a> for more information.</p></li>
<li><p>Make sure the script is executable. Otherwise, ansible will not be able
to use it.</p></li>
</ul>
</div>
<p>For instance,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook --vault-id some_id@/path/to/keyring-client.sh some_playbook.yml
</pre></div>
</div>
<p>will result in <code class="code bash docutils literal notranslate"><span class="pre">keyring-client.sh</span></code> to be invoked as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/path/to/keyring-client.sh --vault-id some_id
</pre></div>
</div>
<p>Let us delve into a more detailed example:</p>
<p><strong>Assumptions</strong></p>
<ol class="arabic">
<li><p>Ansible is being run from
three clusters.Cluster orchestrators (masters) are
named after the convention <code class="code bash docutils literal notranslate"><span class="pre">cluster&lt;cluster</span> <span class="pre">number&gt;.&lt;domain&gt;</span></code> and
compute nodes <code class="code bash docutils literal notranslate"><span class="pre">compute&lt;cluster</span> <span class="pre">number&gt;-&lt;number&gt;</span></code>. e.g. Cluster 1
is comprised of <code class="code bash docutils literal notranslate"><span class="pre">cluster1.local</span></code> and  <code class="code bash docutils literal notranslate"><span class="pre">compute-1-0.local</span></code>,
<code class="code bash docutils literal notranslate"><span class="pre">compute-1-1.local</span></code>.</p></li>
<li><p>Clusters 1 and 2 belong to the production environment. Cluster 3 belongs to
the development environment.</p></li>
<li><p>Servers from a particular cluster cannot access servers from other
cluster.</p></li>
<li><p>The script <code class="code bash docutils literal notranslate"><span class="pre">/usr/sbin/keyring-client.sh</span></code> has the content shown below:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">case</span> <span class="nv">$1</span> in
  <span class="s2">&quot;--vault-id&quot;</span><span class="o">)</span>
  <span class="nb">declare</span> -r <span class="nv">env</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="p">;;</span>
*<span class="o">)</span>
  <span class="nb">exit</span> <span class="m">1</span>
  <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">declare</span> -r <span class="nv">cluster</span><span class="o">=</span><span class="sb">`</span>hostname <span class="p">|</span> awk -F<span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="nb">declare</span> -r <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;ssh remote \</span>
<span class="s2">cat /etc/secrets/</span><span class="nv">$env</span><span class="s2">/</span><span class="nv">$cluster</span><span class="s2">&quot;</span>

<span class="nb">declare</span> -r <span class="nv">vault_passwd</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nv">$cmd</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$vault_passwd</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p>The vault id reprents an environment: dev (development), prod (production).</p></li>
<li><p>A server called <code class="code bash docutils literal notranslate"><span class="pre">remote</span></code> (see line 13 from script) holds multiple passwords,
one per cluster, stored under <code class="code bash docutils literal notranslate"><span class="pre">/etc/secrets/&lt;environment&gt;/&lt;cluster&gt;</span></code>:</p>
<ul class="simple">
<li><p><code class="code bash docutils literal notranslate"><span class="pre">/etc/secrets/prod/cluster1</span></code></p></li>
<li><p><code class="code bash docutils literal notranslate"><span class="pre">/etc/secrets/prod/cluster2</span></code></p></li>
<li><p><code class="code bash docutils literal notranslate"><span class="pre">/etc/secrets/dev/cluster3</span></code></p></li>
</ul>
</li>
</ol>
<p><strong>Sample use case</strong></p>
<ol class="arabic">
<li><p>Create a git repository to hold ansible’s information.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p ~/ansible
<span class="nb">cd</span> ~/ansible
git init
</pre></div>
</div>
</li>
<li><p>Create an inventory file.</p>
<div class="highlight-INI notranslate"><div class="highlight"><pre><span></span><span class="c1">; ~/ansible/inventory</span>

<span class="k">[cluster1]</span>
<span class="na">cluster1.local</span>
<span class="na">compute-1-0.local</span>
<span class="na">compute-1-1.local</span>

<span class="k">[cluster2]</span>
<span class="na">cluster2.local</span>
<span class="na">compute-2-0.local</span>
<span class="na">compute-2-1.local</span>

<span class="k">[cluster3]</span>
<span class="na">cluster3.local</span>
<span class="na">compute-3-0.local</span>
<span class="na">compute-3-1.local</span>

<span class="k">[clusters]</span>
<span class="na">cluster1</span>
<span class="na">cluster2</span>
<span class="na">cluster3</span>
</pre></div>
</div>
</li>
<li><p>Create a playbook to change the root password. Since repeating code is an awful
practice, we decided to create a reusable task and manage the user password
through a variable.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ~/ansible/playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">clusters</span>
  <span class="nt">tasks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Set root password</span>
    <span class="nt">user</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
      <span class="nt">password</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">root_password_hash</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</li>
<li><p>Retrive each root password hash.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Password - cluster1: 123</span>
openssl passwd -1 -salt
Password:
Verifying - Password:
<span class="nv">$1$PpScqWH9</span>$/Rpsq9/mJVxnaCEmrSAv31
<span class="c1"># Password - cluster2: 456</span>
openssl passwd -1 -salt
Password:
Verifying - Password:
<span class="nv">$1$RB</span>/C07h4<span class="nv">$t1lWpEQO</span>/APEBwYPyhjai1
<span class="c1"># Password - cluster3: 789</span>
openssl passwd -1 -salt
Password:
Verifying - Password:
<span class="nv">$1$mRBrUoTy$xAoiS8xIeT6pm8HZZvKmL1</span>
</pre></div>
</div>
</li>
<li><p>Encrypt the hashes using the vault-password
script. Note the process is exactly the same for all
servers (login, run ansible-vault, paste hash, press Ctrl-d, retrieve hash),
therefore showing it for one will be enough of a clarification.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<ul class="simple">
<li><p>DO NOT underestimate string trimming. That is, Vault does not
trim any \n. Hence, pasting the hash, pressing [Return] and then
[Ctrl]-[d] would include an EOL.</p></li>
<li><p>Remember to give Vault’s –vault-id option the apropriate
environment for each server.</p></li>
</ul>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh cluster1.local
ansible-vault encrypt_string <span class="se">\</span>
--vault-id prod@/usr/sbin/keyring-client.sh <span class="se">\</span>
--stdin-name <span class="s1">&#39;root_password_hash&#39;</span>
Reading plaintext input from stdin. <span class="o">(</span>ctrl-d to end input<span class="o">)</span>
<span class="nv">$1$PpScqWH9</span>$/Rpsq9/mJVxnaCEmrSAv31root_password_hash: !vault <span class="p">|</span>
    <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.2<span class="p">;</span>AES256<span class="p">;</span>prod
    <span class="m">34376666646335616561643965613763613163623262663262313961613262316565623237363434</span>
    6138363635336330616364633539653466323264653133330a326465346136383635343961346434
    <span class="m">66376665356534616366333465346166633364373438623133623363303262343464663266623337</span>
    6136363864643936620a373734656435376331393265653138613835336237636437656666663361
    <span class="m">66636130613232383766656134306566353562333166323164663731623238353430633830343833</span>
    <span class="m">6131643734643639383332613635323264363065316464366232</span>
Encryption successful
<span class="nb">exit</span>
</pre></div>
</div>
</li>
<li><p>Create the group variable <code class="code bash docutils literal notranslate"><span class="pre">root_password_hash</span></code> and assign it the
appropriate hash.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p ~/ansible/group_vars
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ~/ansible/group_vars/cluster1</span>
<span class="nn">---</span>
<span class="nt">root_password_hash</span><span class="p">:</span> <span class="kt">!vault</span> <span class="p p-Indicator">|</span>
    <span class="no">$ANSIBLE_VAULT;1.2;AES256;prod</span>
    <span class="no">34376666646335616561643965613763613163623262663262313961613262316565623237363434</span>
    <span class="no">6138363635336330616364633539653466323264653133330a326465346136383635343961346434</span>
    <span class="no">66376665356534616366333465346166633364373438623133623363303262343464663266623337</span>
    <span class="no">6136363864643936620a373734656435376331393265653138613835336237636437656666663361</span>
    <span class="no">66636130613232383766656134306566353562333166323164663731623238353430633830343833</span>
    <span class="no">6131643734643639383332613635323264363065316464366232</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ~/ansible/group_vars/cluster2</span>
<span class="nn">---</span>
<span class="nt">root_password_hash</span><span class="p">:</span> <span class="kt">!vault</span> <span class="p p-Indicator">|</span>
    <span class="no">$ANSIBLE_VAULT;1.2;AES256;prod</span>
    <span class="no">&lt;encrypted hash&gt;</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ~/ansible/group_vars/cluster3</span>
<span class="nn">---</span>
<span class="nt">root_password_hash</span><span class="p">:</span> <span class="kt">!vault</span> <span class="p p-Indicator">|</span>
    <span class="no">$ANSIBLE_VAULT;1.2;AES256;dev</span>
    <span class="no">&lt;encrypted hash&gt;</span>
</pre></div>
</div>
<p>Note how each vault id corresponds to the cluster’s environment, which, in this case, determines
the script’s behavior (see figure <a class="reference internal" href="#fig-sample-vault-script-workflow"><span class="std std-ref">Sample vault script workflow</span></a>).</p>
</li>
<li><p>Connect the repository to Github, Gitlab or any other remote platform. Then commit and push the changes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/ansible
git remote add origin git@github.com:username/ansible
git add --all
git commit -m <span class="s2">&quot;&lt;some message&gt;&quot;</span>
git push -u origin master
</pre></div>
</div>
</li>
<li><p>Download the repository from each cluster orchestrator and run ansible.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since clusters cannot see each other, ansible will only apply
changes to the servers belonging to the same cluster an orchestrator
is member of despite the existance of multiple cluster declarations
within the inventory file. This approach, however, is not recommended
for a production environment.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh cluster1.local
<span class="nb">cd</span> /etc
git clone git@github.com:username/ansible
ansible-playbook --vault-id prod@/usr/sbin/keyring-client.sh <span class="se">\</span>
-i /etc/ansible/inventory <span class="se">\</span>
/etc/ansible/site.yml
<span class="nb">exit</span>

ssh cluster2.local
<span class="nb">cd</span> /etc
git clone git@github.com:username/ansible
ansible-playbook --vault-id prod@/usr/sbin/keyring-client.sh <span class="se">\</span>
-i /etc/ansible/inventory <span class="se">\</span>
/etc/ansible/site.yml
<span class="nb">exit</span>

ssh cluster3.local
<span class="nb">cd</span> /etc
git clone git@github.com:username/ansible
ansible-playbook --vault-id dev@/usr/sbin/keyring-client.sh <span class="se">\</span>
-i /etc/ansible/inventory <span class="se">\</span>
/etc/ansible/site.yml
<span class="nb">exit</span>
</pre></div>
</div>
<p>In order to decrypt the variable <code class="code bash docutils literal notranslate"><span class="pre">root_password_hash</span></code> ansible executes <code class="code bash docutils literal notranslate"><span class="pre">/usr/sbin/keyring-client.sh</span></code>,
which:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Acesses <code class="code bash docutils literal notranslate"><span class="pre">remote</span></code> using ssh</p></li>
<li><p>Retrieves the appropriate password, contingent on the cluster’s name and
environment.</p></li>
<li><p>Prints the password to the standard output.</p></li>
</ol>
</div></blockquote>
<p>The workflow depicted in the figure <a class="reference internal" href="#fig-sample-vault-script-workflow"><span class="std std-ref">Sample vault script workflow</span></a> shows what ansible will do on each
cluster.</p>
<div class="figure align-default" id="id7">
<span id="fig-sample-vault-script-workflow"></span><img alt="Simple vault-password script workflow" src="../../../_images/simple_vault-password_script_workflow.png" />
<p class="caption"><span class="caption-text">Sample vault script workflow</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="environments">
<span id="sssec-ansible-envs"></span><h1><span class="section-number">7. </span>Environments<a class="headerlink" href="#environments" title="Permalink to this headline">¶</a></h1>
<p>Environments provide a way to reuse ansible components (tasks, roles, playbooks, etc.) on
multiple systems by maintaining different inventory files within the same project; which might also
mean multiple <code class="code bash docutils literal notranslate"><span class="pre">group_vars</span></code> and <code class="code bash docutils literal notranslate"><span class="pre">host_vars</span></code> folders. Environments are usually
used for testing purposes, such as verifying the integrity of
features to be introduced in production servers.</p>
<p>Instead of being an ansible feature, environments are more of a concept materialized on the
project’s directory layout. Take the example from the <a class="reference internal" href="#roles">Roles</a> section:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>playbook.yml
inventory
group_vars/
  lbnorth
  lbsouth
roles/
  nginx/
    tasks/
      packages.yml
      config.yml
      main.yml
    handlers/
      main.yml
    templates/
      /etc/nginx/conf/nginx.conf.j2
    vars/
      config.yml
</pre></div>
</div>
<p>If one were to constantly update the production servers, it would be wise
to test changes on a system replica before releasing them. In order
to create such replica, either using a virtual or physical machine,
one must ensure equivalent operations to be applied over
the testing servers, thus compelling them to become alike to their
production counterparts. This is accomplished by reusing the
entire project, but running ansible against different inventory files
on each system:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>playbook.yml
<span class="hll">environments/
</span><span class="hll">  production/
</span><span class="hll">    inventory
</span><span class="hll">    group_vars/
</span><span class="hll">  development/
</span><span class="hll">    inventory
</span><span class="hll">    group_vars/
</span>group_vars/
  lbnorth
  lbsouth
roles/
  nginx/
    tasks/
      packages.yml
      config.yml
      main.yml
    handlers/
      main.yml
    templates/
      /etc/nginx/conf/nginx.conf.j2
    vars/
      config.yml
</pre></div>
</td></tr></table></div>
<ul>
<li><p>For production servers</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i <span class="nv">$ANSIBLE_HOME</span>/environments/production/inventory <span class="se">\</span>
<span class="nv">$ANSIBLE_HOME</span>/playbook.yml
</pre></div>
</div>
</li>
<li><p>For testing servers</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i <span class="nv">$ANSIBLE_HOME</span>/environments/development/inventory <span class="se">\</span>
<span class="nv">$ANSIBLE_HOME</span>/playbook.yml
</pre></div>
</div>
</li>
</ul>
<p>Control over tasks is done by employing variables, tags and/or other metaparameters.
Ansible will load variables from the specified environment, expand them and run
tasks accordingly, as depicted in figure <a class="reference internal" href="#fig-simple-multienv-activity-diagram"><span class="std std-ref">Simple multi-environment activity diagram</span></a>.</p>
<div class="figure align-default" id="id8">
<span id="fig-simple-multienv-activity-diagram"></span><img alt="Simple multi-environment activity diagram" src="../../../_images/simple_multienv_activity_diagram.png" />
<p class="caption"><span class="caption-text">Simple multi-environment activity diagram</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
<p class="rubric">References</p>
<dl class="footnote brackets">
<dt class="label" id="one"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p>Ansible Vault, August 17 - 2018. Retrieved August 30 - 2018, from <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html?highlight=vault">https://docs.ansible.com/ansible/latest/user_guide/vault.html?highlight=vault</a></p>
</dd>
<dt class="label" id="two"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p>Ansible Vault, Providing Vault Passwords, August 17 - 2018. Retrieved August 30 - 2018, from <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html?highlight=vault#providing-vault-passwords">https://docs.ansible.com/ansible/latest/user_guide/vault.html?highlight=vault#providing-vault-passwords</a>.</p>
</dd>
<dt class="label" id="three"><span class="brackets"><a class="fn-backref" href="#id4">3</a></span></dt>
<dd><p>Issue: Allow the vault_id to be passed to vault password scripts #31001, September 27 - 2018. Retrieved Retrieved August 30 - 2018, from <a class="reference external" href="https://github.com/ansible/ansible/issues/31001">https://github.com/ansible/ansible/issues/31001</a></p>
</dd>
<dt class="label" id="four"><span class="brackets"><a class="fn-backref" href="#id5">4</a></span></dt>
<dd><p>Vault secrets client inc new ‘keyring’ client #27669, October 13 - 2018. Retrieved August 30 - 2018, from <a class="reference external" href="https://github.com/ansible/ansible/pull/27669">https://github.com/ansible/ansible/pull/27669</a></p>
</dd>
<dt class="label" id="five"><span class="brackets"><a class="fn-backref" href="#id1">5</a></span></dt>
<dd><p>Using Roles, September 06 - 2018. Retrieved September 06 - 2018, from <a class="reference external" href="https://docs.ansible.com/ansible/2.5/user_guide/playbooks_reuse_roles.html#using-roles">https://docs.ansible.com/ansible/2.5/user_guide/playbooks_reuse_roles.html#using-roles</a></p>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dynamic_control.html" class="btn btn-neutral float-right" title="1. Tags" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Ansible" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Creative Commons Attribution-NonCommercial 4.0 International License

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>