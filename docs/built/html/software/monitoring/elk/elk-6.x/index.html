

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ELK Stack 6.x Installation and Configuration &mdash; apolo-docs 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/sidebar.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Grafana" href="../../grafana/index.html" />
    <link rel="prev" title="ELK" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

  
    <a href="../../../../index.html">
  

  
    
    <img src="../../../../_static/apolo-white.png" style="width: 150px;" class="logo" alt="Logo"/>
  
    </a>

    
      
      
      
	<div class="version" style="color: rgba(255,255,255,0.5);">
	  0.1
	</div>
      
    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../supercomputers/index.html">Supercomputers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../virtualization/index.html">Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../programminglanguages/index.html">Programming Languages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../applications/index.html">Scientific Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../resourcemanager/index.html">Resource Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../provisioning/index.html">Provisioning</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Monitoring</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../architecture/index.html">Monitoring Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nagios/index.html">Nagios</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensu/index.html">Sensu</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">ELK</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">ELK Stack 6.x Installation and Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana/index.html">Grafana</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../operatingsystems/index.html">Operating Systems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to-acknowledge.html">How to Acknowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../report-a-bug.html">Report a Bug</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">apolo-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Software</a> &raquo;</li>
        
          <li><a href="../../index.html">Monitoring</a> &raquo;</li>
        
          <li><a href="../index.html">ELK</a> &raquo;</li>
        
      <li>ELK Stack 6.x Installation and Configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/software/monitoring/elk/elk-6.x/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="elk-stack-6-x-installation-and-configuration">
<span id="elk-6-x-index"></span><h1><a class="toc-backref" href="#id1">ELK Stack 6.x Installation and Configuration</a><a class="headerlink" href="#elk-stack-6-x-installation-and-configuration" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#elk-stack-6-x-installation-and-configuration" id="id1">ELK Stack 6.x Installation and Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#basic-information" id="id2">Basic information</a></p></li>
<li><p><a class="reference internal" href="#installation" id="id3">Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#elasticsearch" id="id4">Elasticsearch</a></p></li>
<li><p><a class="reference internal" href="#kibana" id="id5">Kibana</a></p></li>
<li><p><a class="reference internal" href="#logstash" id="id6">Logstash</a></p></li>
<li><p><a class="reference internal" href="#filebeat" id="id7">Filebeat</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#testing" id="id8">Testing</a></p></li>
<li><p><a class="reference internal" href="#authors" id="id9">Authors</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Install Java JDK 8, more recent versions may have compatibility problems.</p></li>
<li><p>You must use the same version for Logstash, Elasticsearch, Kibana to avoid compatibility problems.</p></li>
<li><p>Also, when reading the guides check that the guide version is compatible with the version of your ELK stack.</p></li>
<li><p>Consider the amount of RAM used by Logstash and Elasticsearch. By default 1GB for heap, plus the JVM which is about 2.5 GB of RAM.</p></li>
<li><p>Install, configure, and start the services in the following order, then you will avoid repeating some steps, and also some problems. Note that this order is the same as the one in the role <em>elk</em>.</p>
<ul>
<li><p>Elasticsearch: <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.6/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.6/index.html</a></p></li>
<li><p>Kibana: <a class="reference external" href="https://www.elastic.co/guide/en/kibana/6.6/index.html">https://www.elastic.co/guide/en/kibana/6.6/index.html</a></p></li>
<li><p>Logstash: <a class="reference external" href="https://www.elastic.co/guide/en/logstash/6.6/index.html">https://www.elastic.co/guide/en/logstash/6.6/index.html</a></p></li>
<li><p>Filebeat: <a class="reference external" href="https://www.elastic.co/guide/en/beats/filebeat/6.6/index.html">https://www.elastic.co/guide/en/beats/filebeat/6.6/index.html</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="basic-information">
<h2><a class="toc-backref" href="#id2">Basic information</a><a class="headerlink" href="#basic-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Official website:</strong> <a class="reference external" href="https://www.elastic.co/elk-stack">https://www.elastic.co/elk-stack</a></p></li>
</ul>
</div>
<div class="section" id="installation">
<span id="installation-label"></span><h2><a class="toc-backref" href="#id3">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The architecture in which the ELK Stack was installed is the following.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    ELK Server
   ----------------
     Kibana
     Elasticsearch
     Logstash
   ----------------
          <span class="o">||</span>
          <span class="o">||</span>
          <span class="o">||</span>
  ------------------
  <span class="p">|</span>                <span class="p">|</span>
------------      ------------
  Filebeat          Filebeat
------------      ------------
 Beat Server       Beat Server
</pre></div>
</div>
<p>Also, it is important to note that the stack of applications was installed on CentOS 7 using <a class="reference external" href="https://www.ansible.com/">Ansible</a>. Therefore, in the next subsections, there will be an explanation of the tasks used to install each of the ELK Stack components.</p>
<p>Before proceeding to the installation of each main component, it is needed to add the ELK’s repository to the rpm’s repositories.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Download public signing key</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Add elk repository file</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/yum.repos.d/elk.repo.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/yum.repos.d/elk.repo&quot;</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  
</pre></div>
</div>
<p>This playbook basically adds the ELK’s gpg signing key and takes a template to render it in the <code class="code bash docutils literal notranslate"><span class="pre">/etc/yum/repos.d/</span></code> directory, which is where <code class="code bash docutils literal notranslate"><span class="pre">rpm</span></code> looks for its repositories. The template file is this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">elastic-</span><span class="p p-Indicator">{{</span> <span class="nv">elk_version</span> <span class="p p-Indicator">}}]</span>
<span class="l l-Scalar l-Scalar-Plain">name=Elastic repository for {{ elk_version }} packages</span>
<span class="l l-Scalar l-Scalar-Plain">baseurl=https://artifacts.elastic.co/packages/{{ elk_version }}/yum</span>
<span class="l l-Scalar l-Scalar-Plain">gpgcheck=1</span>
<span class="l l-Scalar l-Scalar-Plain">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>
<span class="l l-Scalar l-Scalar-Plain">enabled=1</span>
<span class="l l-Scalar l-Scalar-Plain">autorefresh=1</span>
<span class="l l-Scalar l-Scalar-Plain">type=rpm-md</span>
</pre></div>
</div>
<p>The <code class="code yaml docutils literal notranslate"><span class="punctuation indicator"><span class="pre">{{</span></span> <span class="name variable"><span class="pre">elk_version</span></span> <span class="punctuation indicator"><span class="pre">}}</span></span></code> jinja variable refers to the version of your desired stack. In this case 6.c. This variable must be passed as an argument when running ansible or have it defined somewhere in your ansible project. For more information about variables go to the Ansible’s <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">documentation</a>.</p>
<p>Also, it is needed to install Java 8 and the main components (elasticsearch, logstash, kibana) packages.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Java</span>
  <span class="nt">yum</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">java-{{ java_version }}-openjdk-devel</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install logstash-elasticsearch-kibana</span>
  <span class="nt">yum</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">logstash</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kibana</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>
</div>
<p>The variable <code class="code yaml docutils literal notranslate"><span class="punctuation indicator"><span class="pre">{{</span></span> <span class="name variable"><span class="pre">java_version</span></span> <span class="punctuation indicator"><span class="pre">}}</span></span></code> represents the java version used, in our case (and due to compatibility) 1.8.0.</p>
<div class="section" id="elasticsearch">
<h3><a class="toc-backref" href="#id4">Elasticsearch</a><a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h3>
<p>After installing the needed package, Elasticsearch is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure elasticsearch</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/elasticsearch/elasticsearch.yml.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/elasticsearch/elasticsearch.yml&quot;</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_elasticsearch</span>
</pre></div>
</div>
<p>The Elasticsearch main configuration file, which is a template, is rendered in <code class="code bash docutils literal notranslate"><span class="pre">/etc/elasticsearch/</span></code>. The template can be found <a class="reference download internal" download="" href="../../../../_downloads/89dccda68462299e1466b832e1e527bb/elasticsearch.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. In that template, you will find a variable called <code class="code yaml docutils literal notranslate"><span class="punctuation indicator"><span class="pre">{{</span></span> <span class="name variable"><span class="pre">machine</span></span> <span class="punctuation indicator"><span class="pre">}}</span></span></code>, which is rendered as the hostname of our ELK server, in our case <em>elk</em>. So in your case, you can use whatever you want, but from now on in this guide, we will use the hostname <em>elk</em>. Also, when the configuration file is placed, a notify is made so that the Elasticsearch service is started/restarted. The handler looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_elasticsearch</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="kibana">
<span id="kibana-label"></span><h3><a class="toc-backref" href="#id5">Kibana</a><a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h3>
<p>After installing the needed package, Kibana is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure kibana</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/kibana/kibana.yml.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/kibana/kibana.yml&quot;</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_kibana</span>
</pre></div>
</div>
<p>The Kibana main configuration file, which is a template, is rendered in <code class="code bash docutils literal notranslate"><span class="pre">/etc/kibana/</span></code>. The template can be found <a class="reference download internal" download="" href="../../../../_downloads/7113eaa58e686afe4789f272567ea33d/kibana.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. Also, when the configuration file is placed, a notify is made so that the Kibana service is started/restarted. The handler looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_kibana</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kibana</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
<p>After installing and configuring Kibana, it is time to give structure to our logs and create/import the dashboards and visualizations needed:</p>
<ol class="arabic simple">
<li><p>Access the web interface through <em>http://elk:5601</em>. To access it using the domain name <em>elk</em> remember to add elk to your <em>hosts</em> file.</p></li>
<li><p>Organize the information. This will help you plot all your data easily.</p></li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Create the indexes, and the mappings BEFORE sending any data to Elasticsearch.</p>
</div>
<ol class="loweralpha simple">
<li><p>Create <em>indexes</em> and <em>mappings</em>, that is, give types and formats to your data.</p>
<ul class="simple">
<li><p>In the <em>Dev Tools</em> section, copy and paste the content of the index and mappings <a class="reference download internal" download="" href="../../../../_downloads/a44729a4f2746420fa65b09907a31668/index_and_mappings.txt"><code class="xref download docutils literal notranslate"><span class="pre">file</span></code></a>, then select it all and click on RUN. Note that these mappings are the ones that we use, you can take them as an example and create yours, for more information go to ELK’s documentation about <a class="reference external" href="https://www.elastic.co/guide/en/kibana/current/tutorial-load-dataset.html#_set_up_mappings">mappings</a>.</p></li>
<li><p>To easily see your mappings go to: Management -&gt; Index management -&gt; Select your index -&gt; Mapping.</p></li>
</ul>
</li>
<li><p>Continue with <strong>c</strong> and <strong>d</strong> steps after <a class="reference internal" href="#filebeat-label"><span class="std std-ref">Filebeat</span></a> is sending information as well as logstash is filtering it and passing it to elasticsearch. So please go to <a class="reference internal" href="#filebeat-label"><span class="std std-ref">Filebeat</span></a>.</p>
<ul class="simple">
<li><p>You can check that it is already done if you can create <em>index patterns</em>, that is, it won’t let you create them if you don’t have any data.</p></li>
</ul>
</li>
<li><p>Create the dashboard and visualizations.</p>
<ul class="simple">
<li><p>Go to <em>Management</em>, then, under the Kibana section go to <em>Saved Objects</em>, then, <em>Import</em>, and import the dashboards and visualizations <a class="reference download internal" download="" href="../../../../_downloads/3bbd8f9c3442eed087aa7aebd832ecec/dashboards_and_visualizations.json"><code class="xref download docutils literal notranslate"><span class="pre">file</span></code></a>.</p></li>
<li><p>If you want to export the visualizations to a JSON format, remember to export every saved object, because some visualizations may depend on other objects and they won’t work if you don’t export them all.</p></li>
</ul>
</li>
<li><p>In the section <em>Management</em> -&gt; <em>Index Patterns</em> select one (no matter which one) index pattern and press the start button to make it the default one.</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="logstash">
<h3><a class="toc-backref" href="#id6">Logstash</a><a class="headerlink" href="#logstash" title="Permalink to this headline">¶</a></h3>
<p>After installing the needed package, Logstash is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure logstash</span>
  <span class="nt">copy</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/logstash/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/logstash/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">with_items</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pipelines.yml</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">logstash.yml</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_logstash</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Logstash main pipeline configuration file</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/logstash/conf.d/main_pipeline.conf.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/logstash/conf.d/main_pipeline.conf&quot;</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_logstash</span>
</pre></div>
</div>
<p>The first task copies two configuration files, <em>pipelines.yml</em> and <em>logstash.yml</em>. The first file indicates to Logstash where to find our pipelines configuration files. You can find it <a class="reference download internal" download="" href="../../../../_downloads/ae16c868a895f64fc88f543ef489cf2b/pipelines.yml"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. The second one is the main configuration file for Logstash. You can find it <a class="reference download internal" download="" href="../../../../_downloads/0b1cc020ff7051a9938a82374dba9488/logstash.yml"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>The second task takes a template and renders it in the pipelines directory. The template represents the description of our main pipeline, that is, inputs, filters, and outputs. You can find it <a class="reference download internal" download="" href="../../../../_downloads/dfd44770337867e42e22a4e1ece6c0a7/main_pipeline.conf.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Logstash Filters:</strong> It is important to know the version of the filter plugins that you are using so you will be able to search for the proper documentation.</p>
</div>
</div>
<div class="section" id="filebeat">
<span id="filebeat-label"></span><h3><a class="toc-backref" href="#id7">Filebeat</a><a class="headerlink" href="#filebeat" title="Permalink to this headline">¶</a></h3>
<p>Remember that in our case Filebeat is installed in servers different from the ELK Server, see <a class="reference internal" href="#installation-label"><span class="std std-ref">Installation</span></a>.</p>
<p>So, the installation playbook looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Download public signing key</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Add elk repository file</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;etc/yum.repos.d/elk.repo.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&quot;/etc/yum.repos.d/elk.repo&quot;</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
    
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install filebeat</span>
  <span class="nt">yum</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filebeat</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure filebeat</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">etc/filebeat/filebeat.yml.j2</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/filebeat/filebeat.yml</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rot</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_filebeat</span>
</pre></div>
</div>
<p>As previously explained, the three first tasks are for adding the ELK’s repository and installing the main component package. The last task is for configuring Filebeat. It takes a template file, which contains the Filebeat main configuration, that is, where it will take the logs from. You can find the template file <a class="reference download internal" download="" href="../../../../_downloads/f662059d4ca8fd0a4c7a3bce50ecc9ec/filebeat.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. Then, after Filebeat is configured, a notification is sent to a handler to start/restart the Filebeat service. The handler looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_restart_filebeat</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filebeat</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing">
<h2><a class="toc-backref" href="#id8">Testing</a><a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>If you want to test all the ELK Stack locally you can easily do it using <a class="reference external" href="https://www.vagrantup.com/intro/index.html">Vagrant</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Elasticsearch and Logstash use together at least 5 GB of RAM when not in idle state.</p>
</div>
<p>The vagrantfile looks like this:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="c1"># All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure</span>
<span class="c1"># configures the configuration version (we support older styles for</span>
<span class="c1"># backwards compatibility). Please don&#39;t change it unless you know what</span>
<span class="c1"># you&#39;re doing.</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;cr0n05&quot;</span><span class="p">,</span> <span class="ss">autostart</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">cronos</span><span class="o">|</span>
    
    <span class="n">cronos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos/7&quot;</span>
    <span class="n">cronos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.1.2&quot;</span>
    <span class="n">cronos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;cr0n05&quot;</span>

    <span class="n">cronos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">end</span>

    <span class="n">cronos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible_local&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">become</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;site.yml&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;vv&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">machine</span><span class="p">:</span> <span class="s2">&quot;cr0n05&quot;</span>
      <span class="p">}</span>
    <span class="k">end</span>
    
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;4p0l0&quot;</span><span class="p">,</span> <span class="ss">autostart</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">apolo</span><span class="o">|</span>
    
    <span class="n">apolo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos/7&quot;</span>
    <span class="n">apolo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.1.3&quot;</span>
    <span class="n">apolo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;4p0l0&quot;</span>

    <span class="n">apolo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">end</span>

    <span class="n">apolo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible_local&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">become</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;site.yml&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;vv&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">machine</span><span class="p">:</span> <span class="s2">&quot;4p0l0&quot;</span>
      <span class="p">}</span>
    <span class="k">end</span>
    
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;elk&quot;</span><span class="p">,</span> <span class="ss">autostart</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">elk</span><span class="o">|</span>
    
    <span class="n">elk</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos/7&quot;</span>
    <span class="n">elk</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.1.4&quot;</span>
    <span class="n">elk</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;elk&quot;</span>

    <span class="n">elk</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="k">end</span>

    <span class="n">elk</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible_local&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">become</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;site.yml&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;vv&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">machine</span><span class="p">:</span> <span class="s2">&quot;elk&quot;</span>
      <span class="p">}</span>
    <span class="k">end</span>
    
  <span class="k">end</span>
  
<span class="k">end</span>
</pre></div>
</div>
<p>In the configuration of each virtual machine, there is a subsection for provisioning. In that subsection, there is a variable that is accessed as <code class="code bash docutils literal notranslate"><span class="pre">ansible.playbook</span></code>. You have to set it to the path to your ansible playbook. You should use the playbook that was explained in the previous section, <a class="reference internal" href="#installation-label"><span class="std std-ref">Installation</span></a>. Also in this provisioning subsection, note that the <code class="code bash docutils literal notranslate"><span class="pre">ansible.extra_vars</span></code> defines a variable called <code class="code bash docutils literal notranslate"><span class="pre">machine</span></code>, so if you are using the playbook explained before, this variable must match the hostname of the virtual machine. The hostname of the virtual machine can be changed with the variable <code class="code bash docutils literal notranslate"><span class="pre">vm.hostname</span></code>. For more information read the Vagrant documentation about <a class="reference external" href="https://www.vagrantup.com/docs/vagrantfile/">vagrantfiles</a>.</p>
<p>To start up the virtual cluster use the following bash script with the argument <code class="code bash docutils literal notranslate"><span class="pre">up</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    vagrant up elk cr0n05 4p0l0 --no-provision
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;provision-elk&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    vagrant provision elk
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;provision-filebeat&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    vagrant provision cr0n05 4p0l0    
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: ./run.sh up|provision-elk|provision-filebeat&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Change elk, cr0n05, 4p0l0, to the virtual machine names that you set up in your Vagrantfile. If you are using the vagrantfile from above, you do not have to change them.</p>
</div>
<p>Make the virtual machines visible between them by their hostname. You just have to change the <code class="code bash docutils literal notranslate"><span class="pre">/etc/hosts</span></code> file and add the ip address of the virtual machine that you want to see followed by its hostname. For example, make elk visible by others and in the <em>elk</em> machine.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># file /etc/hosts</span>
<span class="l l-Scalar l-Scalar-Plain">0.0.0.0         elk</span>      <span class="c1"># allow others to use the elk hostname instead of the ip</span>
<span class="l l-Scalar l-Scalar-Plain">192.168.1.2     cr0n05</span>   <span class="c1"># make cr0n05 visible to elk by its hostname not just its ip</span>
<span class="l l-Scalar l-Scalar-Plain">192.168.1.3     4p0l0</span>
</pre></div>
</div>
<p>After making them visible, run the script with the argument <code class="code bash docutils literal notranslate"><span class="pre">provision-elk</span></code> so that Elasticsearch, Logstash, and Kibana will be installed. Configure Kibana as explained in <a class="reference internal" href="#kibana-label"><span class="std std-ref">Kibana</span></a>. Then run the script with the argument <code class="code bash docutils literal notranslate"><span class="pre">provision-filebeat</span></code>. When it finishes you should be able to open your browser in the elk machine’s ip address port 5601.</p>
</div>
<div class="section" id="authors">
<h2><a class="toc-backref" href="#id9">Authors</a><a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Hamilton Tobon Mosquera &lt;<a class="reference external" href="mailto:htobonm&#37;&#52;&#48;eafit&#46;edu&#46;co">htobonm<span>&#64;</span>eafit<span>&#46;</span>edu<span>&#46;</span>co</a>&gt;</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../grafana/index.html" class="btn btn-neutral float-right" title="Grafana" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="ELK" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Creative Commons Attribution-NonCommercial 4.0 International License

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>